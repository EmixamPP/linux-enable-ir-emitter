name: OpenCV dependency
on:
  schedule:
    - cron:  '0 7 * * *'

jobs:
  depend-opencv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch release version
        env:
            GITHUB_TOKEN: ${{ github.token }}
            OWNER: opencv
            REPO: opencv
        run: |
            VERSION=$(gh api "/repos/$OWNER/$REPO/releases/latest" --jq ".tag_name")
            echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Modify files if new version
        run: |
            sed -E -i "s@(OPENCV_TINY_VERSION:\s+\")([0-9]+\.[0-9]+\.[0-9]+)(\")@\1$VERSION\3@" .github/workflows/{ci,arm}.yml
            sed -E -i "s@(curl https://raw.githubusercontent.com/EmixamPP/opencv-tiny/main/build.sh | bash -s )[0-9]+\.[0-9]+\.[0-9]+(.*)@\1$VERSION\2@" README.md
            
      - name: Create PR if new version
        uses: peter-evans/create-pull-request@v5
        with:
            token: ${{ secrets.PAT }}
            title: "chore(deps): update opencv to ${{ env.VERSION }}"
            branch: "opencv-${{ env.VERSION }}"
            commit-message: "chore(deps): update opencv to ${{ env.VERSION }}"
            body: |
              Update OpenCV to ${{ env.VERSION }}.

              This PR has been created automatically.
            committer: github-actions[bot] <noreply@github.com>
            author: github-actions[bot] <noreply@github.com>
            assignees: "EmixamPP"
            delete-branch: true
     